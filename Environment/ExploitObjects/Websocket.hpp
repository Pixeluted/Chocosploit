//
// Created by Pixeluted on 05/05/2025.
//
#pragma once
#include "../ExploitObject.hpp"
#include "ixwebsocket/IXWebSocket.h"

static int indexCloseRef;
static int indexSendRef;

struct Websocket final : ExploitObject<WebsocketObject> {
    const char* GetObjectMtName() override;
    void InitializeObjectMetatable(lua_State* L) override;

    std::shared_ptr<ix::WebSocket> websocketObject;
    int onMessageRef;
    int onCloseRef;
    int userdataRef;
    std::string lastWebsocketErrorMessage;
    std::atomic_bool isUseable;
    std::atomic_bool isClosing;

    ~Websocket() override;
};

std::shared_ptr<Websocket> CreateNewWebsocket(lua_State* L, const std::string& websocketUrl);
void CloseWebsocketInstance(const std::shared_ptr<Websocket>& instance, bool fireClosedConnection = true);